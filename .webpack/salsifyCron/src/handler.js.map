{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./models/Sheet.js","webpack:///./src/handler.js","webpack:///./utils/db.js","webpack:///external \"babel-runtime/core-js/json/stringify\"","webpack:///external \"babel-runtime/core-js/promise\"","webpack:///external \"babel-runtime/helpers/asyncToGenerator\"","webpack:///external \"babel-runtime/regenerator\"","webpack:///external \"envdotjs\"","webpack:///external \"isomorphic-fetch\"","webpack:///external \"middy\"","webpack:///external \"middy/middlewares\"","webpack:///external \"mongoose\"","webpack:///external \"source-map-support/register\""],"names":["mongoose","require","SheetSchema","Schema","sheetId","String","status","url","module","exports","model","load","salsifyCron","event","context","callback","callbackWaitsForEmptyEventLoop","options","headers","Authorization","Sheet","find","storedData","console","log","process","exit","length","method","body","config","then","res","json","id","create","resWithId","estimated_time_remaining","findByIdAndUpdate","new","use","Promise","global","isConnected","connectToDatabase","resolve","connect","db","connections","readyState"],"mappings":"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","file":"src/handler.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/handler.js\");\n","const mongoose = require('mongoose');\nconst SheetSchema = new mongoose.Schema({\n  sheetId: String,\n  status: String,\n  url: String\n});\nmodule.exports = mongoose.model('Sheet', SheetSchema);\n","require('envdotjs').load();\nimport fetch from 'isomorphic-fetch';\nimport middy from 'middy';\nimport { jsonBodyParser, httpErrorHandler, cors } from 'middy/middlewares';\n\nimport { connectToDatabase } from '../utils/db';\nimport Sheet from '../models/Sheet';\nimport config from '../utils/config';\n\nmodule.exports.salsifyCron = middy(async (event, context, callback) => {\n  context.callbackWaitsForEmptyEventLoop = false;\n\n  let sheetId;\n  const options = {\n    url: `https://app.salsify.com/api/orgs/${\n      process.env.SALSIFY_ORG_ID\n    }/export_runs`,\n    headers: {\n      Authorization: `Bearer ${process.env.SALSIFY_API_KEY}`,\n      'Content-Type': 'application/json'\n    }\n  };\n  await connectToDatabase();\n\n  const storedData = await Sheet.find({});\n  if (\n    storedData[0] &&\n    storedData[0].status === 'completed' &&\n    storedData[0].url !== null\n  ) {\n    console.log(\n      'There is already a completed sheet in the DB: \\n' +\n        `Sheet ID: ${storedData[0].sheetId}, \\nSheet status: ${\n          storedData[0].status\n        }, \\nSheet url: ${storedData[0].url}`\n    );\n    process.exit(0);\n    return;\n  }\n  if (storedData[0]) {\n    sheetId = storedData[0].sheetId;\n  }\n  if (storedData.length === 0) {\n    const res = await fetch(options.url, {\n      method: 'POST',\n      headers: options.headers,\n      body: JSON.stringify(config)\n    }).then(res => res.json());\n    if (res.id && res.status) {\n      await Sheet.create({\n        sheetId: res.id,\n        url: null,\n        status: res.status\n      });\n      sheetId = res.id;\n    } else {\n      console.log(res);\n      process.exit(1);\n    }\n  }\n\n  const resWithId = await fetch(`${options.url}/${sheetId}`, {\n    method: 'GET',\n    headers: options.headers\n  }).then(res => res.json());\n\n  if (resWithId.status === 'running') {\n    console.log('running cron job');\n    console.log(resWithId.estimated_time_remaining);\n  }\n  if (resWithId.status === 'completed') {\n    console.log('completed cron job');\n    await Sheet.findByIdAndUpdate(\n      storedData[0],\n      { status: resWithId.status, url: resWithId.url },\n      { new: true }\n    );\n  }\n})\n  .use(cors())\n  .use(jsonBodyParser())\n  .use(httpErrorHandler());\n","import envdotjs from 'envdotjs';\nimport mongoose from 'mongoose';\nmongoose.Promise = global.Promise;\nlet isConnected;\nconst connectToDatabase = () => {\n  if (isConnected) {\n    return Promise.resolve();\n  }\n  return mongoose.connect(process.env.DB_URI).then(db => {\n    isConnected = db.connections[0].readyState;\n  });\n};\n\nmodule.exports = {\n  connectToDatabase\n};\n","module.exports = require(\"babel-runtime/core-js/json/stringify\");","module.exports = require(\"babel-runtime/core-js/promise\");","module.exports = require(\"babel-runtime/helpers/asyncToGenerator\");","module.exports = require(\"babel-runtime/regenerator\");","module.exports = require(\"envdotjs\");","module.exports = require(\"isomorphic-fetch\");","module.exports = require(\"middy\");","module.exports = require(\"middy/middlewares\");","module.exports = require(\"mongoose\");","module.exports = require(\"source-map-support/register\");"],"sourceRoot":""}